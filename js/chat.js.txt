document.addEventListener('DOMContentLoaded', function() {
    // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø´Ø§Øª
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiContainer = document.getElementById('emoji-container');
    
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª
    const emojis = [
        'ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡',
        'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š',
        'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¥¸',
        'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜Ÿ', 'ðŸ˜•', 'ðŸ™', 'â˜¹ï¸',
        'ðŸ˜£', 'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ¥º', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡',
        'ðŸ¤¬', 'ðŸ¤¯', 'ðŸ˜³', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ˜±', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜“',
        'ðŸ¤—', 'ðŸ¤”', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤¥', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¬', 'ðŸ™„',
        'ðŸ˜¯', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜®', 'ðŸ˜²', 'ðŸ¥±', 'ðŸ˜´', 'ðŸ¤¤', 'ðŸ˜ª', 'ðŸ˜µ',
        'ðŸ¤', 'ðŸ¥´', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤‘', 'ðŸ¤ ',
        'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ‘¹', 'ðŸ‘º', 'ðŸ¤¡', 'ðŸ’©', 'ðŸ‘»', 'ðŸ’€', 'â˜ ï¸', 'ðŸ‘½',
        'ðŸ‘¾', 'ðŸ¤–', 'ðŸŽƒ', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€',
        'ðŸ˜¿', 'ðŸ˜¾', 'ðŸ™ˆ', 'ðŸ™‰', 'ðŸ™Š', 'ðŸ’‹', 'ðŸ’Œ', 'ðŸ’˜', 'ðŸ’', 'ðŸ’–',
        'ðŸ’—', 'ðŸ’“', 'ðŸ’ž', 'ðŸ’•', 'ðŸ’Ÿ', 'â£ï¸', 'ðŸ’”', 'â¤ï¸', 'ðŸ§¡', 'ðŸ’›',
        'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ¤Ž', 'ðŸ–¤', 'ðŸ¤', 'ðŸ’¯', 'ðŸ’¢', 'ðŸ’¥', 'ðŸ’«',
        'ðŸ’¦', 'ðŸ’¨', 'ðŸ•³ï¸', 'ðŸ’£', 'ðŸ’¬', 'ðŸ‘ï¸â€ðŸ—¨ï¸', 'ðŸ—¨ï¸', 'ðŸ—¯ï¸', 'ðŸ’­', 'ðŸ’¤'
    ];

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´Ø§Øª
    initChat();

    function initChat() {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Firebase
        loadMessages();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø´Ø§Øª
        setupChatEvents();
    }

    function setupChatEvents() {
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendBtn.addEventListener('click', sendMessage);
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª
        emojiBtn.addEventListener('click', function() {
            emojiContainer.style.display = emojiContainer.style.display === 'flex' ? 'none' : 'flex';
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
        emojis.forEach(emoji => {
            const emojiElement = document.createElement('span');
            emojiElement.textContent = emoji;
            emojiElement.style.cursor = 'pointer';
            emojiElement.style.fontSize = '1.5rem';
            emojiElement.style.margin = '0.2rem';
            emojiElement.addEventListener('click', function() {
                messageInput.value += emoji;
                messageInput.focus();
            });
            emojiContainer.appendChild(emojiElement);
        });
    }

    function sendMessage() {
        const messageText = messageInput.value.trim();
        
        if (messageText && window.currentUser) {
            const messageData = {
                sender: window.currentUser.code,
                text: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Firebase
            firebase.database().ref('messages').push(messageData);
            
            // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            messageInput.value = '';
        }
    }

    function loadMessages() {
        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Firebase
        firebase.database().ref('messages').on('child_added', (snapshot) => {
            const message = snapshot.val();
            displayMessage(message.sender, message.text, message.timestamp);
        });
    }

    function displayMessage(senderId, text, timestamp, isCurrentUser = false) {
        // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (window.currentUser) {
            isCurrentUser = senderId === window.currentUser.code;
        }
        
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ù† Firebase
        firebase.database().ref('users/' + senderId).once('value').then((snapshot) => {
            const senderData = snapshot.val() || { 
                name: `User${senderId.replace(/\D/g,'')}`, 
                avatar: 'default.png' 
            };
            
            const now = new Date(timestamp);
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
            
            // ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ±Ø§Øª Ø®Ø§ØµØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
            let nameDisplay = senderData.name;
            if (senderData.nameEffect === 'rainbow') {
                nameDisplay = `<span class="rainbow-text">${nameDisplay}</span>`;
            } else if (senderData.nameEffect === 'gold') {
                nameDisplay = `<span class="gold-text">${nameDisplay}</span>`;
            } else if (senderData.nameColor) {
                nameDisplay = `<span style="color: ${senderData.nameColor}">${nameDisplay}</span>`;
            }
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${nameDisplay}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-content">${text}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ„ÙŠØ³Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (!isCurrentUser && !document.hasFocus()) {
                showNotification(`Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${senderData.name}`);
            }
        });
    }

    function showNotification(message) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        if (!("Notification" in window)) {
            return;
        }
        
        // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ù…ÙˆØ­Ø§Ù‹ Ø¨Ø¹Ø¯
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ù…ÙˆØ­Ø§Ù‹
        if (Notification.permission === "granted") {
            new Notification("Greatness Chat", {
                body: message,
                icon: "images/avatars/default.png"
            });
        }
    }
});