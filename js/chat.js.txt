document.addEventListener('DOMContentLoaded', function() {
    // العناصر الأساسية للشات
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiContainer = document.getElementById('emoji-container');
    
    // قائمة الإيموجيات
    const emojis = [
        '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
        '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
        '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🥸',
        '🤩', '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️',
        '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡',
        '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓',
        '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄',
        '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵',
        '🤐', '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠',
        '😈', '👿', '👹', '👺', '🤡', '💩', '👻', '💀', '☠️', '👽',
        '👾', '🤖', '🎃', '😺', '😸', '😹', '😻', '😼', '😽', '🙀',
        '😿', '😾', '🙈', '🙉', '🙊', '💋', '💌', '💘', '💝', '💖',
        '💗', '💓', '💞', '💕', '💟', '❣️', '💔', '❤️', '🧡', '💛',
        '💚', '💙', '💜', '🤎', '🖤', '🤍', '💯', '💢', '💥', '💫',
        '💦', '💨', '🕳️', '💣', '💬', '👁️‍🗨️', '🗨️', '🗯️', '💭', '💤'
    ];

    // تهيئة الشات
    initChat();

    function initChat() {
        // تحميل الرسائل السابقة من Firebase
        loadMessages();
        
        // إعداد أحداث الشات
        setupChatEvents();
    }

    function setupChatEvents() {
        // إرسال الرسالة عند الضغط على زر الإرسال
        sendBtn.addEventListener('click', sendMessage);
        
        // إرسال الرسالة عند الضغط على Enter
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // عرض/إخفاء الإيموجيات
        emojiBtn.addEventListener('click', function() {
            emojiContainer.style.display = emojiContainer.style.display === 'flex' ? 'none' : 'flex';
        });
        
        // إضافة الإيموجيات إلى الحاوية
        emojis.forEach(emoji => {
            const emojiElement = document.createElement('span');
            emojiElement.textContent = emoji;
            emojiElement.style.cursor = 'pointer';
            emojiElement.style.fontSize = '1.5rem';
            emojiElement.style.margin = '0.2rem';
            emojiElement.addEventListener('click', function() {
                messageInput.value += emoji;
                messageInput.focus();
            });
            emojiContainer.appendChild(emojiElement);
        });
    }

    function sendMessage() {
        const messageText = messageInput.value.trim();
        
        if (messageText && window.currentUser) {
            const messageData = {
                sender: window.currentUser.code,
                text: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // إرسال الرسالة إلى Firebase
            firebase.database().ref('messages').push(messageData);
            
            // مسح حقل الإدخال
            messageInput.value = '';
        }
    }

    function loadMessages() {
        // استقبال الرسائل الجديدة من Firebase
        firebase.database().ref('messages').on('child_added', (snapshot) => {
            const message = snapshot.val();
            displayMessage(message.sender, message.text, message.timestamp);
        });
    }

    function displayMessage(senderId, text, timestamp, isCurrentUser = false) {
        // تحقق مما إذا كانت الرسالة من المستخدم الحالي
        if (window.currentUser) {
            isCurrentUser = senderId === window.currentUser.code;
        }
        
        // جلب بيانات المرسل من Firebase
        firebase.database().ref('users/' + senderId).once('value').then((snapshot) => {
            const senderData = snapshot.val() || { 
                name: `User${senderId.replace(/\D/g,'')}`, 
                avatar: 'default.png' 
            };
            
            const now = new Date(timestamp);
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
            
            // تطبيق تأثيرات خاصة إذا وجدت
            let nameDisplay = senderData.name;
            if (senderData.nameEffect === 'rainbow') {
                nameDisplay = `<span class="rainbow-text">${nameDisplay}</span>`;
            } else if (senderData.nameEffect === 'gold') {
                nameDisplay = `<span class="gold-text">${nameDisplay}</span>`;
            } else if (senderData.nameColor) {
                nameDisplay = `<span style="color: ${senderData.nameColor}">${nameDisplay}</span>`;
            }
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${nameDisplay}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-content">${text}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // إظهار إشعار إذا كانت الرسالة جديدة وليست من المستخدم الحالي
            if (!isCurrentUser && !document.hasFocus()) {
                showNotification(`رسالة جديدة من ${senderData.name}`);
            }
        });
    }

    function showNotification(message) {
        // التحقق من دعم الإشعارات
        if (!("Notification" in window)) {
            return;
        }
        
        // طلب الإذن لعرض الإشعارات إذا لم يكن مسموحاً بعد
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }
        
        // عرض الإشعار إذا كان مسموحاً
        if (Notification.permission === "granted") {
            new Notification("Greatness Chat", {
                body: message,
                icon: "images/avatars/default.png"
            });
        }
    }
});